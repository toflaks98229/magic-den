<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="google-site-verification" content="ryEIWRKwGUx2h6MtYKfdXt62mNUYPWqhrufxZ2ytwTQ" />
    <title>소코반 챌린지 - 온라인 두뇌 퍼즐 웹게임</title>
    
    <meta name="description" content="온라인에서 바로 즐기는 클래식 소코반 퍼즐 게임! 90개의 레벨에 도전하고, 직접 맵 에디터로 자신만의 맵을 만들어 보세요.">

    <meta name="keywords" content="소코반, 소코반 게임, Sokoban, 웹게임, 퍼즐 게임, 두뇌 게임, 온라인 게임, 맵 에디터">

    <meta name="author" content="<사용자님의 이름 또는 닉네임>">

    <meta property="og:title" content="소코반 챌린지 - 온라인 퍼즐 게임">
    <meta property="og:description" content="상자를 밀어 목표 지점에 도달하세요! 웹에서 바로 즐기는 클래식 소코반 게임.">
    <meta property="og:image" content="<게임 스크린샷 이미지 주소>">
    <meta property="og:url" content="https://<사용자이름>.github.io/<저장소이름>/">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
            touch-action: manipulation;
        }
        canvas {
            background-color: #1a202c;
            border-radius: 0.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .sokoban-btn {
            transition: all 0.2s ease-in-out;
        }
        .sokoban-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        .sokoban-btn:active {
            transform: translateY(0);
        }
        .modal {
            transition: opacity 0.3s ease-in-out;
        }
        .modal-content {
            transition: transform 0.3s ease-in-out;
        }
        #loader {
            border: 8px solid #f3f3f3;
            border-top: 8px solid #3498db;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 2s linear infinite;
        }
         #action-icon-img {
            transition: opacity 0.15s ease-in-out;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-900 text-white flex flex-col items-center justify-center min-h-screen p-4">

    <div id="startScreen" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 modal">
        <div class="modal-content bg-gray-800 border border-cyan-500 rounded-2xl p-8 text-center shadow-lg">
            <div id="loader-container" class="flex flex-col items-center justify-center">
                 <div id="loader"></div>
                 <p class="text-gray-300 mt-4 text-lg">에셋 로딩 중...</p>
            </div>
            <div id="start-content" class="hidden">
                <h2 class="text-4xl font-bold text-cyan-400 mb-4">소코반 챌린지</h2>
                <p class="text-gray-300 mb-8">상자를 목표 지점으로 옮겨보세요!</p>
                <button id="startGameBtn" class="sokoban-btn bg-cyan-600 hover:bg-cyan-500 text-white font-bold py-3 px-10 rounded-lg text-xl">
                    게임 시작
                </button>
            </div>
        </div>
    </div>
    
    <div id="gameClearModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center hidden opacity-0 z-40 modal">
        <div class="modal-content bg-gray-800 border border-green-500 rounded-2xl p-8 text-center shadow-lg transform scale-95">
            <h2 class="text-3xl font-bold text-green-400 mb-4">🎉 모든 레벨 클리어! 🎉</h2>
            <p class="text-gray-300 mb-6">소코반 마스터가 되셨군요! 대단합니다!</p>
            <button id="restartGameBtn" class="sokoban-btn bg-green-600 hover:bg-green-500 text-white font-bold py-2 px-8 rounded-lg text-lg">처음부터 다시하기</button>
        </div>
    </div>
    
    <div id="levelCompleteModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center hidden opacity-0 z-40 modal">
        <div class="modal-content bg-gray-800 border border-cyan-500 rounded-2xl p-8 text-center shadow-lg transform scale-95">
            <h2 class="text-3xl font-bold text-cyan-400 mb-4">레벨 클리어!</h2>
            <p class="text-gray-300 mb-6">다음 레벨에 도전하시겠습니까?</p>
            <button id="modalNextLevelBtn" class="sokoban-btn bg-cyan-600 hover:bg-cyan-500 text-white font-bold py-2 px-8 rounded-lg text-lg">다음 레벨</button>
        </div>
    </div>

    <div id="game-wrapper" class="w-full max-w-4xl mx-auto hidden">
       <header class="text-center mb-4 hidden"> 
            <h1 class="text-4xl font-bold text-cyan-400 tracking-wider">소코반 (Sokoban)</h1>
            <p class="text-gray-400 mt-2">상자를 목표 지점으로 모두 옮기세요.</p>
        </header>

        <div class="bg-gray-800 p-4 sm:p-6 rounded-xl shadow-2xl border border-gray-700 flex flex-col h-[88vh]">
            <div class="flex flex-wrap items-start justify-between gap-4 mb-4">
                <!-- 왼쪽 영역: 레벨 정보 및 맵 불러오기 -->
                <div>
                    <div class="flex items-center gap-4 mb-2">
                        <div class="flex items-center gap-2">
                            <label for="level-select" class="font-bold">레벨:</label>
                            <select id="level-select" class="bg-gray-700 border border-gray-600 rounded-md p-2 text-white focus:outline-none focus:ring-2 focus:ring-cyan-500"></select>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="font-bold">행동 횟수:</span>
                            <span id="move-count" class="font-bold text-cyan-400 text-lg">0</span>
                        </div>
                    </div>
    
                    <div>
                        <input type="file" id="map-file-input" accept=".txt" class="hidden">
                        <button id="load-map-btn" class="sokoban-btn bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg shadow-md text-sm">커스텀 맵 불러오기</button>
                        <p id="map-load-status" class="text-left text-sm text-yellow-400 h-4 mt-1"></p>
                    </div>
                </div>
                
                <!-- 오른쪽 영역: 게임 컨트롤 버튼 -->
                <div class="flex items-center gap-2 sm:gap-4 w-full sm:w-auto justify-center">
                    <button id="prev-level-btn" class="sokoban-btn bg-cyan-600 hover:bg-cyan-500 text-white font-bold py-2 px-4 rounded-lg shadow-md">&lt; 이전</button>
                    <button id="reset-btn" class="sokoban-btn bg-red-600 hover:bg-red-500 text-white font-bold py-2 px-4 rounded-lg shadow-md">다시 시작</button>
                    <button id="next-level-btn" class="sokoban-btn bg-cyan-600 hover:bg-cyan-500 text-white font-bold py-2 px-4 rounded-lg shadow-md">다음 &gt;</button>
                </div>
            </div>

            <div id="player-action-status" class="bg-gray-900 bg-opacity-50 rounded-lg flex items-center justify-center transition-all duration-300 mx-auto mb-2 w-60 h-60 border-2 border-cyan-500 overflow-hidden">
                <img id="action-icon-img" src="" alt="Action Status" class="w-full h-full object-cover">
            </div>

            <div id="canvas-container" class="relative w-full flex-1 flex items-center justify-center min-h-0">
                <canvas id="gameCanvas"></canvas>
            </div>
            
            <div class="mt-4 grid grid-cols-3 gap-2 max-w-xs mx-auto sm:hidden">
                <div></div>
                <button id="up-btn" class="sokoban-btn bg-gray-700 p-3 rounded-lg">▲</button>
                <div></div>
                <button id="left-btn" class="sokoban-btn bg-gray-700 p-3 rounded-lg">◀</button>
                <button id="down-btn" class="sokoban-btn bg-gray-700 p-3 rounded-lg">▼</button>
                <button id="right-btn" class="sokoban-btn bg-gray-700 p-3 rounded-lg">▶</button>
            </div>
        </div>
    </div>

    <script>
        // --- 게임 요소 상수 ---
        const WALL = '#';
        const FLOOR = ' ';
        const PLAYER = '@';
        const PLAYER_ON_GOAL = '+';
        const BOX = '$';
        const BOX_ON_GOAL = '*';
        const GOAL = '.';
        
        // --- 에셋 경로 ---
        const IMAGE_PATHS = {
            player_idle: './Image/player_idle.png',
            player_move: './Image/player_move.png',
            player_push: './Image/player_push.png',
            // wall과 floor를 배열로 변경
            walls: [
                './Image/wall_1.png'
            ], 
            floors: [
                './Image/floor_1.png', 
                './Image/floor_2.png',
                './Image/floor_3.png',
                './Image/floor_4.png'
            ],
            box: './Image/box.png',
            box_on_goal: './Image/box_on_goal.png',
            goal: './Image/goal.png',
        };

        const ACTION_ICON_PATHS = {
            idle_1: './Image/status_idle.png',
            idle_2: './Image/status_idle_2.png',
            move: './Image/status_exploring.png',
            push: './Image/status_push.png',
        };

        const SOUND_PATHS = {
            move: './Sound/move.wav',
            push: './Sound/push.wav',
            clear: './Sound/clear.wav',
        };

        const ELEMENT_IMAGE_MAP = {
            [WALL]: 'wall',
            [FLOOR]: 'floor',
            [BOX]: 'box',
            [BOX_ON_GOAL]: 'box_on_goal',
            [GOAL]: 'goal',
        };

        const SVG_ASSETS = {
            [PLAYER]: `<svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><g transform="translate(0 -5)"><path d="M50 45a15 15 0 110-30 15 15 0 010 30z" fill="#63b3ed"></path><path d="M80 95S80 75 50 75 20 95 20 95z" fill="#4299e1"></path></g></svg>`,
            [PLAYER_ON_GOAL]: `<svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><g transform="translate(0 -5)"><path d="M50 45a15 15 0 110-30 15 15 0 010 30z" fill="#90cdf4"></path><path d="M80 95S80 75 50 75 20 95 20 95z" fill="#63b3ed"></path></g></svg>`,
            [BOX]: `<svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><defs><linearGradient id="boxGrad" x1="0" y1="0" x2="1" y2="1"><stop offset="0%" stop-color="#d69e2e"/><stop offset="100%" stop-color="#975a16"/></linearGradient></defs><rect x="10" y="10" width="80" height="80" rx="10" fill="url(#boxGrad)"/><rect x="20" y="20" width="60" height="60" rx="5" fill="none" stroke="#fff" stroke-width="5" stroke-opacity="0.2"/></svg>`,
            [BOX_ON_GOAL]: `<svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><defs><linearGradient id="boxGoalGrad" x1="0" y1="0" x2="1" y2="1"><stop offset="0%" stop-color="#48bb78"/><stop offset="100%" stop-color="#2f855a"/></linearGradient></defs><rect x="10" y="10" width="80" height="80" rx="10" fill="url(#boxGoalGrad)"/><path d="M30 50l15 15 25-25" stroke="#fff" stroke-width="8" fill="none" stroke-linecap="round" stroke-linejoin="round"/></svg>`,
            [WALL]: `<svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><defs><linearGradient id="wallGrad" x1="0" y1="0" x2="1" y2="1"><stop offset="0%" stop-color="#4a5568"/><stop offset="100%" stop-color="#2d3748"/></linearGradient></defs><rect width="100" height="100" fill="url(#wallGrad)"/><path d="M0 0h50v50H0z M50 50h50v50H50z" fill="#2d3748" fill-opacity="0.3"/></svg>`,
            [GOAL]: `<svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><circle cx="50" cy="50" r="35" fill="#e53e3e" fill-opacity="0.5"/><circle cx="50" cy="50" r="20" fill="#e53e3e"/></svg>`,
            [FLOOR]: `<svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><rect width="100" height="100" fill="#1a202c"/></svg>`,
        };
        
        const levelsData = `
       1
    #####
    #   #
    #$  #
  ###  $##
  #  $ $ #
### # ## #   ######
#   # ## #####  ..#
# $  $          ..#
##### ### #@##  ..#
    #     #########
    #######
~
2
############
#..  #     ###
#..  # $  $  #
#..  #$####  #
#..    @ ##  #
#..  # #  $ ##
###### ##$ $ #
  # $  $ $ $ #
  #    #     #
  ############
~
3
        ########
        #     @#
        # $#$ ##
        # $  $#
        ##$ $ #
######### $ # ###
#....  ## $  $  #
##...    $  $   #
#....  ##########
########
~
4
           ########
           #  ....#
############  ....#
#    #  $ $   ....#
# $$$#$  $ #  ....#
#  $     $ #  ....#
# $$ #$ $ $########
#  $ #     #
## #########
#    #    ##
#     $   ##
#  $$#$$  @#
#    #    ##
###########
~
5
        #####
        #   #####
        # #$##  #
        #     $ #
######### ###   #
#....  ## $  $###
#....    $ $$ ##
#....  ##$  $ @#
#########  $  ##
        # $ $  #
        ### ## #
          #    #
          ######
~
6
######  ###
#..  # ##@##
#..  ###   #
#..     $$ #
#..  # # $ #
#..### # $ #
#### $ #$  #
   #  $# $ #
   # $  $  #
   #  ##   #
   #########
~
7
       #####
 #######   ##
## # @## $$ #
#    $      #
#  $  ###   #
### #####$###
# $  ### ..#
# $ $ $ ...#
#    ###...#
# $$ # #...#
#  ### #####
####
~
8
  ####
  #  ###########
  #    $   $ $ #
  # $# $ #  $  #
  #  $ $  #    #
### $# #  #### #
#@#$ $ $  ##   #
#    $ #$#   # #
#   $    $ $ $ #
#####  #########
  #      #
  #      #
  #......#
  #......#
  #......#
  ########
~
9
          #######
          #  ...#
      #####  ...#
      #      . .#
      #  ##  ...#
      ## ##  ...#
     ### ########
     # $$$ ##
 #####  $ $ #####
##   #$ $   #   #
#@ $  $    $  $ #
###### $$ $ #####
     #      #
     ########
~
10
 ###  #############
##@####       #   #
# $$   $$  $ $ ...#
#  $$$#    $  #...#
# $   # $$ $$ #...#
###   #  $    #...#
#     # $ $ $ #...#
#    ###### ###...#
## #  #  $ $  #...#
#  ## # $$ $ $##..#
# ..# #  $      #.#
# ..# # $$$ $$$ #.#
##### #       # #.#
    # ######### #.#
    #           #.#
    ###############
~
11
          ####
     #### #  #
   ### @###$ #
  ##      $  #
 ##  $ $$## ##
 #  #$##     #
 # # $ $$ # ###
 #   $ #  # $ #####
####    #  $$ #   #
#### ## $         #
#.    ###  ########
#.. ..# ####
#...#.#
#.....#
#######
~
12
################
#              #
# # ######     #
# #  $ $ $ $#  #
# #   $@$   ## ##
# #  $ $ $###...#
# #   $ $  ##...#
# ###$$$ $ ##...#
#     # ## ##...#
#####   ## ##...#
    #####     ###
        #     #
        #######
~
13
   #########
  ##   ##  #####
###     #  #    ###
#  $ #$ #  #  ... #
# # $#@$## # #.#. #
#  # #$  #    . . #
# $    $ # # #.#. #
#   ##  ##$ $ . . #
# $ #   #  #$#.#. #
## $  $   $  $... #
 #$ ######    ##  #
 #  #    ##########
 ####
~
14
       #######
 #######     #
 #     # $@$ #
 #$$ #   #########
 # ###......##   #
 #   $......## # #
 # ###......     #
##   #### ### #$##
#  #$   #  $  # #
#  $ $$$  # $## #
#   $ $ ###$$ # #
#####     $   # #
    ### ###   # #
      #     #   #
      ########  #
             ####
~
15
   ########
   #   #  #
   #  $   #
 ### #$   ####
 #  $  ##$   #
 #  # @ $ # $#
 #  #      $ ####
 ## ####$##     #
 # $#.....# #   #
 #  $..**. $# ###
##  #.....#   #
#   ### #######
# $$  #  #
#  #     #
######   #
     #####
~
16
#####
#   ##
#    #  ####
# $  ####  #
#  $$ $   $#
###@ #$    ##
 #  ##  $ $ ##
 # $  ## ## .#
 #  #$##$  #.#
 ###   $..##.#
  #    #.*...#
  # $$ #.....#
  #  #########
  #  #
  ####
~
17
   ##########
   #..  #   #
   #..      #
   #..  #  ####
  #######  #  ##
  #            #
  #  #  ##  #  #
#### ##  #### ##
#  $  ##### #  #
# # $  $  # $  #
# @$  $   #   ##
#### ## #######
   #    #
   ######
~
18
     ###########
     #  .  #   #
     # #.    @ #
 ##### ##..# ####
##  # ..###     ###
# $ #...   $ #  $ #
#    .. ##  ## ## #
####$##$# $ #   # #
  ## #    #$ $$ # #
  #  $ # #  # $## #
  #               #
  #  ###########  #
  ####         ####
~
19
  ######
  #   @####
##### $   #
#   ##    ####
# $ #  ##    #
# $ #  ##### #
## $  $    # #
## $ $ ### # #
## #  $  # # #
## # #$#   # #
## ###   # # ######
#  $  #### # #....#
#    $    $   ..#.#
####$  $# $   ....#
#       #  ## ....#
###################
~
20
    ##########
#####        ####
#     #   $  #@ #
# #######$####  ###
# #    ## #  #$ ..#
# # $     #  #  #.#
# # $  #     #$ ..#
# #  ### ##     #.#
# ###  #  #  #$ ..#
# #    #  ####  #.#
# #$   $  $  #$ ..#
#    $ # $ $ #  #.#
#### $###    #$ ..#
   #    $$ ###....#
   #      ## ######
   ########
~
21
#########
#       #
#       ####
## #### #  #
## #@##    #
# $$$ $  $$#
#  # ## $  #
#  # ##  $ ####
####  $$$ $#  #
 #   ##   ....#
 # #   # #.. .#
 #   # # ##...#
 ##### $  #...#
     ##   #####
      #####
~
22
######     ####
#    #######  #####
#   $#  #  $  #   #
#  $  $  $ # $ $  #
##$ $   # @# $    #
#  $ ########### ##
# #   #.......# $#
# ##  # ......#  #
# #   $........$ #
# # $ #.... ..#  #
#  $ $####$#### $#
# $   ### $   $  ##
# $     $ $  $    #
## ###### $ ##### #
#         #       #
###################
~
23
    #######
    #  #  ####
##### $#$ #  ##
#.. #  #  #   #
#.. # $#$ #  $####
#.  #     #$  #  #
#..   $#  # $    #
#..@#  #$ #$  #  #
#.. # $#     $#  #
#.. #  #$$#$  #  ##
#.. # $#  #  $#$  #
#.. #  #  #   #   #
##. ####  #####   #
 ####  ####   #####
~
24
###############
#..........  .####
#..........$$.#  #
###########$ #   ##
#      $  $     $ #
## ####   #  $ #  #
#      #   ##  # ##
#  $#  # ##  ### ##
# $ #$###    ### ##
###  $ #  #  ### ##
###    $ ## #  # ##
 # $  #  $  $ $   #
 #  $  $#$$$  #   #
 #  #  $      #####
 # @##  #  #  #
 ##############
~
25
####
#  ##############
#  #   ..#......#
#  # # ##### ...#
##$#    ........#
#   ##$######  ####
# $ #     ######@ #
##$ # $   ######  #
#  $ #$$$##       #
#      #    #$#$###
# #### #$$$$$    #
# #    $     #   #
# #   ##        ###
# ######$###### $ #
#        #    #   #
##########    #####
~
26
 #######
 #  #  #####
##  #  #...###
#  $#  #...  #
# $ #$$ ...  #
#  $#  #... .#
#   # $########
##$       $ $ #
##  #  $$ #   #
 ######  ##$$@#
      #      ##
      ########
~
27
 #################
 #...   #    #   ##
##.....  $## # #$ #
#......#  $  #    #
#......#  #  # #  #
######### $  $ $  #
  #     #$##$ ##$##
 ##   $    # $    #
 #  ## ### #  ##$ #
 # $ $$     $  $  #
 # $    $##$ ######
 #######  @ ##
       ######
~
28
         #####
     #####   #
    ## $  $  ####
##### $  $ $ ##.#
#       $$  ##..#
#  ###### ###.. #
## #  #    #... #
# $   #    #... #
#@ #$ ## ####...#
####  $ $$  ##..#
   ##  $ $  $...#
    # $$  $ #  .#
    #   $ $  ####
    ######   #
         #####
~
29
#####
#   ##
# $  #########
## # #       ######
## #   $#$#@  #   #
#  #      $ #   $ #
#  ### ######### ##
#  ## ..*..... # ##
## ## *.*..*.* # ##
# $########## ##$ #
#  $   $  $    $  #
#  #   #   #   #  #
###################
~
30
       ###########
       #   #     #
#####  #     $ $ #
#   ##### $## # ##
# $ ##   # ## $  #
# $  @$$ # ##$$$ #
## ###   # ##    #
## #   ### #####$#
## #     $  #....#
#  ### ## $ #....##
# $   $ #   #..$. #
#  ## $ #  ##.... #
#####   ######...##
    #####    #####
~
31
  ####
  #  #########
 ##  ##  #   #
 #  $# $@$   ####
 #$  $  # $ $#  ##
##  $## #$ $     #
#  #  # #   $$$  #
# $    $  $## ####
# $ $ #$#  #  #
##  ###  ###$ #
 #  #....     #
 ####......####
   #....####
   #...##
   #...#
   #####
~
32
      ####
  #####  #
 ##     $#
## $  ## ###
#@$ $ # $  #
#### ##   $#
 #....#$ $ #
 #....#   $#
 #....  $$ ##
 #... # $   #
 ######$ $  #
      #   ###
      #$ ###
      #  #
      ####
~
33
 ###########
 #     ##  #
 #   $   $ #
#### ## $$ #
#   $ #    #
# $$$ # ####
#   # # $ ##
#  #  #  $ #
# $# $#    #
#   ..# ####
####.. $ #@#
#.....# $# #
##....#  $ #
 ##..##    #
  ##########
~
34
 #########
 #....   ##
 #.#.#  $ ##
##....# # @##
# ....#  #  ##
#     #$ ##$ #
## ###  $    #
 #$  $ $ $#  #
 # #  $ $ ## #
 #  ###  ##  #
 #    ## ## ##
 #  $ #  $  #
 ###$ $   ###
   #  #####
   ####
~
35
############ ######
#   #    # ###....#
#   $$#   @  .....#
#   # ###   # ....#
## ## ###  #  ....#
 # $ $     # # ####
 #  $ $##  #      #
#### #  #### # ## #
#  # #$   ## #    #
# $  $  # ## #   ##
# # $ $    # #   #
#  $ ## ## # #####
# $$     $$  #
## ## ### $  #
 #    # #    #
 ###### ######
~
36
            #####
#####  ######   #
#   ####  $ $ $ #
# $   ## ## ##  ##
#   $ $     $  $ #
### $  ## ##     ##
  # ##### #####$$ #
 ##$##### @##     #
 # $  ###$### $  ##
 # $  #   ###  ###
 # $$ $ #   $$ #
 #     #   ##  #
 #######.. .###
    #.........#
    #.........#
    ###########
~
37
###########
#......   #########
#......   #  ##   #
#..### $    $     #
#... $ $ #   ##   #
#...#$#####    #  #
###    #   #$  #$ #
  #  $$ $ $  $##  #
  #  $   #$#$ ##$ #
  ### ## #    ##  #
   #  $ $ ## ######
   #    $  $  #
   ##   # #   #
    #####@#####
        ###
~
38
      ####
####### @#
#     $  #
#   $## $#
##$#...# #
 # $...  #
 # #. .# ##
 #   # #$ #
 #$  $    #
 #  #######
 ####
~
39
             ######
 #############....#
##   ##     ##....#
#  $$##  $ @##....#
#      $$ $#  ....#
#  $ ## $$ # # ...#
#  $ ## $  #  ....#
## ##### ### ##.###
##   $  $ ##   .  #
# $###  # ##### ###
#   $   #       #
#  $ #$ $ $###  #
# $$$# $   # ####
#    #  $$ #
######   ###
     #####
~
40
    ############
    #          ##
    #  # #$$ $  #
    #$ #$#  ## @#
   ## ## # $ # ##
   #   $ #$  # #
   #   # $   # #
   ## $ $   ## #
   #  #  ##  $ #
   #    ## $$# #
######$$   #   #
#....#  ########
#.#... ##
#....   #
#....   #
#########
~
41
           #####
          ##   ##
         ##     #
        ##  $$  #
       ## $$  $ #
       # $    $ #
####   #   $$ #####
#  ######## ##    #
#.            $$$@#
#.# ####### ##   ##
#.# #######. #$ $##
#........... #    #
##############  $ #
             ##  ##
              ####
~
42
     ########
  ####      ######
  #    ## $ $   @#
  # ## ##$#$ $ $##
### ......#  $$ ##
#   ......#  #   #
# # ......#$  $  #
# #$...... $$# $ #
#   ### ###$  $ ##
###  $  $  $  $ #
  #  $  $  $  $ #
  ######   ######
       #####
~
43
        #######
    #####  #  ####
    #   #   $    #
 #### #$$ ## ##  #
##      # #  ## ###
#  ### $#$  $  $  #
#...    # ##  #   #
#...#    @ # ### ##
#...#  ###  $  $  #
######## ##   #   #
          #########
~
44
 #####
 #   #
 # # #######
 #      $@######
 # $ ##$ ###   #
 # #### $    $ #
 # ##### #  #$ ####
##  #### ##$      #
#  $#  $  # ## ## #
#         # #...# #
######  ###  ...  #
     #### # #...# #
          # ### # #
          #       #
          #########
~
45
##### ####
#...# #  ####
#...###  $  #
#....## $  $###
##....##   $  #
###... ## $ $ #
# ##    #  $  #
#  ## # ### ####
# $ # #$  $    #
#  $ @ $    $  #
#   # $ $$ $ ###
#  ######  ###
# ##    ####
###
~
46
##########
#        ####
# ###### #  ##
# # $ $ $  $ #
#       #$   #
###$  $$#  ###
  #  ## # $##
  ##$#   $ @#
   #  $ $ ###
   # #   $  #
   # ##   # #
  ##  ##### #
  #         #
  #.......###
  #.......#
  #########
~
47
         ####
 #########  ##
##  $      $ #####
#   ## ##   ##...#
# #$$ $ $$#$##...#
# #   @   #   ...#
#  $# ###$$   ...#
# $  $$  $ ##....#
###$       #######
  #  #######
  ####
~
48
  #########  
  #*.*#*.*#  
  #.*.*.*.#  
  #*.*.*.*#  
  #.*.*.*.#  
  #*.*.*.*#  
  ###   ###  
    #   #    
###### ######
#           #
# $ $ $ $ $ #
## $ $ $ $ ##
 #$ $ $ $ $# 
 #   $@$   # 
 #  #####  # 
 ####   ####
~
49
       ####
       #  ##
       #   ##
       # $$ ##
     ###$  $ ##
  ####    $   #
###  # #####  #
#    # #....$ #
# #   $ ....# #
#  $ # #.*..# #
###  #### ### #
  #### @$  ##$##
     ### $     #
       #  ##   #
       ######### 
~
50
      ############
     ##..    #   #
    ##..* $    $ #
   ##..*.# # # $##
   #..*.# # # $  #
####...#  #    # #
#  ## #          #
# @$ $ ###  #   ##
# $   $   # #   #
###$$   # # # # #
  #   $   # # #####
  # $# #####      #
  #$   #   #    # #
  #  ###   ##     #
  #  #      #    ##
  ####      ######
~
51
 #########
 #       #
 # $ $$ $#
### #  $ #
#.#   $$ ##
#.###   $ #
#.#. $ ## ####
#...  $## $  #
#...$   $    #
#..###$### #@#
#..# #     ###
#### #######
~
52
           ########
           #......#
   ####    #......#
   #  #########...#
   # $   $    #...#
   #  # # # # #   #
##### # # #@# #   #
#   # ### ### ## ##
#    $ # $ $ $ # #
# $$$  $   #     #
#   # ###$###$## #
### #  $   #     #
 ## $  # $ $ $ ###
 #  # ### ### ##  
 # $          #   
 #  ###########   
 ####
~
53
####################
#    ##   #    #   #
#  $  $     ## $   #
## #####  .###### ##
 # ##  ##....#### ##
## ##$ ###..##     #
#      #... .# $ $ #
# $ ## ## . ### ####
# # $    #.## # #
# $ $ #   .#### ##
# #  ## # ##  #  ##
#######  $##$   $ #
      ##      $ #@#
       #  ## ######
       #######
~
54
####################
#   #    #   #   #@#
# $      $   $   # #
## ###..## ###     #
#   #....#$#  $### #
# $ #....#  $  $ $ #
#   #....# # # $ $ #
#   ##..##   #$#   #
##$##    ##  #  #$##
#   $  $     #  #  #
#   #    #   #     #
####################
~
55
####################
#    @##      #   ##
#    ##    $    $ ##
#  ###....# # #  ###
#   #....# # # $   #
### #...#  #       #
##  ##.#     $   $ #
##  $ $ ###  # # ###
## $       # # $   #
#### $  $# # # # $ #
####         # #  ##
####################
~
56
####################
#  #  ##    #   @###
##    $    # $###  #
##$# $ ##$# $ $    #
#   $#    $      ###
# ##   $ ###  #....#
# # $# # # # #....##
#    $ $ #  #....###
##$ ###  $ #....####
#  # $        ######
#      # #    ######
####################
~
57
####################
#@     ###   #  #  #
# # #  #  $  $     #
#####     # $ $#$# #
#.#..#    ##$ $    #
#.....    $   #   ##
#.....    ###$##$###
#.#..#    $    #   #
#####     #  #$  $ #
#####  #  $    $ $ #
#####  #  #  #  #  #
####################
~
58
####################
##...   ## #    #  #
#....         $ ## #
#....# # #$###$    #
#...#    #       # #
##.#  #$ #     $## #
#  #  # $ $ ###  $ #
#     $  $ #  # ## #
## # ## #$$# $#  # #
#  #   $ $ #      ##
#    #     #  #   @#
####################
~
59
####################
#   #  #@# ##  #####
# # #  $    $  #####
# #    ###### $  ###
#   #  #....#  $$  #
##$##$##....#      #
#      #....##$##$##
#  $$  #....#      #
# $  $  #  #  ###  #
#####  $   $    $  #
##### #    #  #   ##
####################
~
60
####################
# #     #          #
#       $  ## ### ##
#####  ##   $  $   #
##..##  # # $ # #  #
#....  $     ##$# ##
#....  $#####   #$##
##..# #  #   #  $  #
###.# #  $   $  # @#
##  $  $ #   #  ####
##       ###########
####################
~
61
####################
#     ###..###     #
# $$  ###..###  $@ #
#  # ##......#  $  #
#     #......#  $  #
####  ###..######$ #
#   $$$ #..#    #  #
# $#   $  $  $$ #$ #
#  #  ## $  ##  #  #
# $    $ ## $    $ #
#  #  ##    ##  #  #
####################
~
62
####################
#    #  # #  #  #  #
# @# # ## $   $   ##
#### #    #  # $   #
#    # ## #$ ## ## #
#      $   $   $   #
#..###$$## $##$ ## #
#..#.#  # $   $ #  #
#....# $$   ##$ ####
#....#  #####      #
#...###        ##  #
####################
~
63
####################
#....#       #  #  #
#....# # $  $      #
#.... ##  $# # $#$ #
#...#   $   $#  $  #
#..####  # $   $$  #
#      #### #### ###
#        #   #     #
# ##   #   $ # $ $ #
# ##    $ ## $  $  #
#     @#     #   # #
####################
~
64
####################
#....###           #
#....##### #  #$# ##
#....###   #$  $   #
#....###    $  #$$##
##  #### $#  #$ $  #
##  ####  $  $  #  #
#@  ####$###$## $  #
##        #  #  $  #
##   ###  #  $  ####
########  #  #     #
####################
~
65
####################
#     #     @#...###
#     #      ##...##
# # # ##$## ## ....#
#   $ #   $$$  ....#
###$### $$  ### ##.#
#     $  #    # ####
#  $  #  ###  # #  #
## #$##    $  $$   #
#   $ ##   #  # #  #
#     #    #  #    #
####################
~
66
####################
#     #  #...#@    #
# #       ....#    #
#  $  #   #....#   #
# ##$#### ##....#  #
# $   $  #  #...#  #
# $$ #   #   # $$  #
###  $$$#   $$  $  #
# $  #  #    # $#  #
#   $#  #       $  #
#  #    #    #  #  #
####################
~
67
####################
#####@###.##...##  #
#####$  ..#...#    #
####    ......#  $ #
###  $ #.....## # ##
##  $$# #####  $ $ #
## $# $    ##  $$  #
##  #  #    # $  $ #
##   $$ ### #$##   #
## $#      $ $  $ ##
###    #    #    ###
####################
~
68
####################
#@     #   #       #
## ### ##  #### # ##
#    # #  $$       #
#  # # # $ # $ ## ##
#     $ #  #$$ #   #
#  ###  #      ## ##
#..#.# $ #  $ #    #
#..#.#  $ # ## $$  #
#....##   $$  $  # #
#.....##        #  #
####################
~
69
####################
#  #      #   #   ##
# $# $ $ ##...$  $ #
#  $  # ##....# $  #
# ## $ ##....#   $ #
# $    #....## $   #
# $##  #...#       #
#   $$$##$##  ### ##
# # #  #   #  #    #
# $ #  $  ##       #
#    #    #@       #
####################
~
70
####################
#  #  # #    #  #  #
#   $      $ $     #
## #  #$###$##  ## #
#   $     $  #  $  #
# ###$##$#   # $   #
# #   $ $  ###### $#
# $  $$ $  #@#.#...#
# #     #  # #.#...#
# ########## #.....#
#            #.....#
####################
~
71
####################
#  #     #  ##    ##
# $#   $ #     ##  #
# $  $  #..#     $ #
# $ $  #....#   # ##
# $#  #......### $ #
#   #  #....#  #$  #
# $  ####..#   #   #
## $   ## # # $  $##
### $    $#@$ $#   #
####   #       #   #
####################
~
72
####################
#      ....#    ####
#      ....        #
# # ##########     #
# #$   #      ###..#
#  $   #$$###   #..#
# $ ### $   $   #..#
# $ #   $ $ #  ##..#
#  #  $$ # $ ##   ##
#@## $#  $  $     ##
##       ##   #  ###
####################
~
73
####################
#        #   #@ #  #
# $$  #$$# # #  ## #
#  # $ $ #$$ #     #
## #  #  # # #  #  #
#   ##       #     #
#   # $ #   #   #  #
# $ #$ #   #  $ #..#
##$ #  ####    #...#
#  $          #....#
#   #  #     #.....#
####################
~
74
####################
#     #   #####    #
## $  #   ####  $  #
#### $$   #..#  #  #
#  $  $  ##..#### ##
# $   ###....   $$ #
#  #$#   ....# # $ #
# #  # $ ..###$#   #
# #   $ #..#   ##  #
#   $#  ####   # $##
# #  #    @#      ##
####################
~
75
####################
#   #   #    #   #@#
#   $  $     # $ # #
##$# $### #    $$# #
#  #  #.###  #$ $  #
#  #$#....#  # ### #
# $  #.....##    # #
##$  #.#....#$$ $  #
#  ######..## #  # #
#  $         $ ### #
#   #   #        # #
####################
~
76
####################
# # # #   #@##   # #
#             $    #
#  ##$# ##### $ # ##
##    ##.....#  #  #
##$##$#.....###$#$ #
#   # ##.....#  # ##
#  $    ##..##  #  #
# $ #   $   $  $$$ #
## $  $# #  #  $   #
#   ##   #  #      #
####################
~
77
######  #####
#    #  #   #
# $  #### $ #
# $      $  #
#  ###@###$ #
########## ###
#..   ##     #
#..   ##$    #
#..   ## $   #
#..   ## $   #
#..     $ $  #
###  #########
  ####
~
78
       ###########
       #         #
       #    $ $  #
###### # $ ##### #
#    ##### $  ##$#
#       $ $      #
#          ## ## #
#    ##@##### ## #
#    ####   # ## ##
#....#      # $   #
#....#      #     #
######      #######
~
79
#############
#           #
# ### $$    #
#   # $  $  #
#  $####$######
# $ ##        #####
#  $$ $        ...#
### ## $$#     ...#
  # ##   #     ...#
  #      #     ...#
  ###@#############
    ###
~
80
  #################
###@##         ...#
#    #         ...#
# $  #         ...#
# $$ #         ...#
## $ ###$##########
 # ###  $ #
##   $  $ #
#  $ #  $ #
# $  #    #
#  $ #    #
#    #    #
###########
~
81
              #####
     ##########   #
     #        #   #
     #  $ $    $$ #
     # ##### ## $ #
     #$$   #$## $ #
     # ### # ##$  #
###### ### $ $    #
#....        ##   #
#....        ######
#....        #
###########@##
          ###
~
82
    ######
 ####    #
 #    ## #
 # $     #
### #### ########
#  $   $ ##  ...#
#   $$ $$    ...#
#    $  $##  ...#
##@## ## ##  ...#
 ###  $  ########
 #   $$  #
 #    #  #
 #########
~
83
####### #########
#     # #   ##  #
# ### # #   $   #
# # $ ###   $   #
#   $$      ##$ #
#    ####   ##  #
#@############ ##
###..    #####$ #
  #..    ####   #
  #..       $$  #
  #..    #### $ #
  #..    #  #   #
  ########  #####
~
84
#######
#     ##########
#     #    #  ##
# $   #   $ $  #
#  $  #  $ ##  #
# $$  ##$ $    #
## #  ## #######
## #  ##    ...#
#  #$       ...#
#   $$      ...#
#     ##@#  ...#
################
~
85
############
#      #   ##
# $  $   #  ######
####  #####      #
 #..  #     #### #
 #.####  ####    #
 #....    #  $ ####
 # ...#   # $$$#  ##
###.#### ##  $@$   #
#     ##### $ #    #
# #.# $      $###$ #
# #.########  #  $ #
# #..        ##  $ #
# # ####### $ # #  #
#   #     #       ##
#####     ##########
~
86
################
#       #@ #   #
# # # # # $  $$#
# #...# #$$$   #
#  ...# # $  $$##
# ##.## # ##    #
# #...     $    #
# ## ###  #######
#    # ####
######
~
87
    #####
 ####   ## #####
 #  $    ###   #
 # $@$ $    $  #
 # #$######## ##
 # #  $  #     #
 # # $ $ # #   #
## #  $# # #####
#  ##    #     #
#    $ # ###   #
##### ##  #....#
#    $     ....#
#         #....#
################
~
88
#############
#........####
#...#### #  #####
#...#  ###    $ #
#...$$     $ $  #
#  .#  $ $# $  ##
#...# #$#   $  #
#.# # $   $    #
#.  #$###$####$#
##  #   $ $    #
 #  #  $@$  #  #
 #  # #### $  $#
 #  #    ###   #
 #  # $$ # #####
 #  #    #
 #########
~
89
 ##################
 #   $       ...#.##
 #       ####..... #
 # #######  #..... #
 # #    $ $ ##....##
 # #  $ # # ###...#
 # # $@$ $  ##### #
## #  $  $ $$   $ #
#  #$# $#   # $## #
# ##    ## ## $ # #
# # $# $ $  #     #
# #         #######
# ########$##   #
#        #  $   #
########    #####
       ###  #
         ####
~
90
####################
#..#    #          #
#.$  $  #$$  $## $##
#.$#  ###  ## ##   #
#  # $ #  $$   $   #
# ###  # #  #$  ####
#  ## # $   #@ #   #
# $    $  ##.##  $ #
#  # $# $# $     ###
#  #  #  #   ###   #
#  ######## #      #
#           #  #.#.#
##$########$#   ...#
#    .*  #    ##.#.#
# .*...*   $  .....#
####################
~

        `;

        // --- DOM 요소 및 상태 변수 ---
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const levelSelect = document.getElementById('level-select');
        const actionIconImg = document.getElementById('action-icon-img');
        const moveCountSpan = document.getElementById('move-count');
        
        let levels = [];
        let currentLevel = 0;
        let map = [];
        let player = { x: 0, y: 0 };
        let history = [];
        let moveCount = 0;
        let tileVariantMap = [];
        let actionTimeout;
        let idleInterval;
        let idleIconKeys = [];
        let currentAction = 'idle';
        let playerDirection = 'right';
        const preRenderedCanvases = {};
        const loadedAssets = {
            images: {},
            sounds: {}
        };
        let currentPlayerSpriteKey = 'player_idle';

        function updateMoveCountDisplay() {
            if (moveCountSpan) {
                moveCountSpan.textContent = moveCount;
            }
        }

        // --- 에셋 로딩 ---
        function loadImage(key, path) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.onload = () => resolve({ key, asset: img });
                img.onerror = () => reject(new Error(`Failed to load image: ${path}`));
                img.src = path;
            });
        }

        function loadSound(key, path) {
            return new Promise((resolve, reject) => {
                const audio = new Audio();
                audio.oncanplaythrough = () => resolve({ key, asset: audio });
                audio.onerror = () => reject(new Error(`Failed to load sound: ${path}`));
                audio.src = path;
            });
        }
        
        async function loadAllAssets() {
            // imagePromises를 만드는 로직을 수정
            const imagePromises = [];
            Object.entries(IMAGE_PATHS).forEach(([key, path]) => {
                if (Array.isArray(path)) {
                    path.forEach((p, index) => {
                        // 고유한 키 생성 (예: walls_0, walls_1)
                        imagePromises.push(loadImage(`${key}_${index}`, p));
                    });
                } else {
                    imagePromises.push(loadImage(key, path));
                }
            });

            const actionIconPromises = Object.entries(ACTION_ICON_PATHS).map(([key, path]) => 
                loadImage(`status_${key}`, path)
            );
            const soundPromises = Object.entries(SOUND_PATHS).map(([key, path]) => loadSound(key, path));

            const imageResults = await Promise.allSettled([...imagePromises, ...actionIconPromises]);
            const soundResults = await Promise.allSettled(soundPromises);

            imageResults.forEach(result => {
                if (result.status === 'fulfilled') {
                    loadedAssets.images[result.value.key] = result.value.asset;
                } else {
                    console.warn(result.reason);
                }
            });

            soundResults.forEach(result => {
                if (result.status === 'fulfilled') {
                    loadedAssets.sounds[result.value.key] = result.value.asset;
                } else {
                    console.warn(result.reason);
                }
            });
        }
        
        function playSound(key) {
            if (loadedAssets.sounds[key]) {
                const sound = loadedAssets.sounds[key].cloneNode();
                sound.play().catch(e => console.error("Sound play failed:", e));
            }
        }

        // --- 핵심 게임 로직 ---
        function parseLevels(data) {
            const levelBlocks = data.split('~');
            
            const parsedLevels = levelBlocks.map(block => {
                return block.split('\n')
                            .filter(line => line.trim().length > 0 && !/^\d+$/.test(line.trim()))
                            .map(line => line.split(''));
            }).filter(level => level.length > 0);

            return parsedLevels.map(level => {
                if (level.length === 0) return [];
                const maxLength = Math.max(...level.map(row => row.length));
                return level.map(row => row.join('').padEnd(maxLength, ' ').split(''));
            });
        }


        function populateLevelSelect() {
            levelSelect.innerHTML = '';
            levels.forEach((_, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = `레벨 ${index + 1}`;
                levelSelect.appendChild(option);
            });
            levelSelect.value = currentLevel;
        }

        function loadLevel(levelNum) {
            if (levelNum < 0 || levelNum >= levels.length) return;
            currentLevel = levelNum;
            levelSelect.value = currentLevel;
            
            map = JSON.parse(JSON.stringify(levels[currentLevel]));

            tileVariantMap = [];
            const wallKeys = Object.keys(loadedAssets.images).filter(k => k.startsWith('walls_'));
            const floorKeys = Object.keys(loadedAssets.images).filter(k => k.startsWith('floors_'));

            for (let y = 0; y < map.length; y++) {
                const row = [];
                for (let x = 0; x < map[y].length; x++) {
                    let variantKey = null;
                    if (map[y][x] === WALL && wallKeys.length > 0) {
                        variantKey = wallKeys[Math.floor(Math.random() * wallKeys.length)];
                    } else if (map[y][x] !== WALL && floorKeys.length > 0) {
                        // 모든 비-벽 타일은 바닥 타일을 가질 수 있습니다.
                        variantKey = floorKeys[Math.floor(Math.random() * floorKeys.length)];
                    }
                    row.push(variantKey);
                }
                tileVariantMap.push(row);
            }

            for (let y = 0; y < map.length; y++) {
                for (let x = 0; x < map[y].length; x++) {
                    if (map[y][x] === PLAYER || map[y][x] === PLAYER_ON_GOAL) {
                        player = { x, y };
                        break;
                    }
                }
            }
            history = [];
            moveCount = 0;
            updateMoveCountDisplay();
            draw();
            updateActionStatus('idle');
        }
        
        function updateActionStatus(status) {
            if (currentAction === status && status === 'idle') {
                return;
            }
            currentAction = status;

            clearTimeout(actionTimeout);
            clearTimeout(idleInterval);

            const setIcon = (iconKey) => {
                const newSrc = loadedAssets.images[iconKey]?.src;
                if (!newSrc) {
                    actionIconImg.style.opacity = 0;
                    return;
                }
                if (actionIconImg.src && actionIconImg.src.endsWith(newSrc.substring(newSrc.lastIndexOf('/')))) {
                    return;
                }
                actionIconImg.style.opacity = 0;
                setTimeout(() => {
                    actionIconImg.src = newSrc;
                    actionIconImg.style.opacity = 1;
                }, 150);
            };

            switch (status) {
                case 'move':
                    currentPlayerSpriteKey = 'player_move';
                    setIcon('status_move');
                    actionTimeout = setTimeout(() => { updateActionStatus('idle'); draw(); }, 1000);
                    break;
                case 'push':
                    currentPlayerSpriteKey = 'player_push';
                    setIcon('status_push');
                    actionTimeout = setTimeout(() => { updateActionStatus('idle'); draw(); }, 1000);
                    break;
                case 'idle':
                default:
                    currentPlayerSpriteKey = 'player_idle';
                    if (idleIconKeys.length > 0) {
                        const showNextRandomIdle = () => {
                            if (currentAction !== 'idle') {
                                return;
                            }
                            const randomIdleKey = idleIconKeys[Math.floor(Math.random() * idleIconKeys.length)];
                            setIcon(randomIdleKey);
                            idleInterval = setTimeout(showNextRandomIdle, 2400);
                        };
                        showNextRandomIdle();
                    } else {
                        actionIconImg.style.opacity = 0;
                    }
                    break;
            }
        }

        function move(dx, dy) {

            if (dx > 0) playerDirection = 'right';
            if (dx < 0) playerDirection = 'left';

            const newPlayerX = player.x + dx;
            const newPlayerY = player.y + dy;

            if (newPlayerY < 0 || newPlayerY >= map.length || newPlayerX < 0 || newPlayerX >= map[newPlayerY].length) return;

            const target = map[newPlayerY][newPlayerX];
            if (target === WALL) return;

            let isPushing = false;
            if (target === BOX || target === BOX_ON_GOAL) {
                const newBoxX = newPlayerX + dx;
                const newBoxY = newPlayerY + dy;

                if (newBoxY < 0 || newBoxY >= map.length || newBoxX < 0 || newBoxX >= map[newBoxY].length) return;

                const afterBox = map[newBoxY][newBoxX];
                if (afterBox === WALL || afterBox === BOX || afterBox === BOX_ON_GOAL) return;
                
                isPushing = true;
            }
            
            history.push({ mapState: JSON.parse(JSON.stringify(map)), moveCountState: moveCount });
            moveCount++;
            updateMoveCountDisplay();

            if (isPushing) {
                const newBoxX = newPlayerX + dx;
                const newBoxY = newPlayerY + dy;
                const afterBox = map[newBoxY][newBoxX];
                playSound('push');
                map[newBoxY][newBoxX] = (afterBox === GOAL) ? BOX_ON_GOAL : BOX;
                map[newPlayerY][newPlayerX] = (target === BOX_ON_GOAL) ? PLAYER_ON_GOAL : PLAYER;
            } else {
                playSound('move');
                map[newPlayerY][newPlayerX] = (target === GOAL) ? PLAYER_ON_GOAL : PLAYER;
            }

            const oldPlayer = map[player.y][player.x];
            map[player.y][player.x] = (oldPlayer === PLAYER_ON_GOAL) ? GOAL : FLOOR;
            
            player = { x: newPlayerX, y: newPlayerY };
            
            updateActionStatus(isPushing ? 'push' : 'move');
            
            draw();
            checkWin();
        }

        function checkWin() {
            if (!map.flat().includes(BOX)) {
                playSound('clear');
                if (currentLevel >= levels.length - 1) {
                    showGameClearModal();
                } else {
                    showLevelCompleteModal();
                }
            }
        }
        
        function showModal(modalId) {
            const modal = document.getElementById(modalId);
            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.classList.remove('opacity-0');
                modal.querySelector('.modal-content').classList.remove('scale-95');
            }, 10);
        }

        function hideModal(modalId) {
            const modal = document.getElementById(modalId);
            modal.classList.add('opacity-0');
            modal.querySelector('.modal-content').classList.add('scale-95');
            setTimeout(() => modal.classList.add('hidden'), 300);
        }

        function showLevelCompleteModal() { showModal('levelCompleteModal'); }
        function showGameClearModal() { showModal('gameClearModal'); }

        // --- 그리기 로직 ---
        function draw() {
            const container = document.getElementById('canvas-container');
            if (!container) return;
            const containerWidth = container.clientWidth;
            const containerHeight = container.clientHeight;

            if (!map.length) return;

            const mapHeight = map.length;
            const mapWidth = Math.max(...map.map(row => row.length));

            const tileSize = Math.floor(Math.min(containerWidth / mapWidth, containerHeight / mapHeight));
            
            if (tileSize <= 0) return;

            canvas.width = mapWidth * tileSize;
            canvas.height = mapHeight * tileSize;
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            for (let y = 0; y < map.length; y++) {
                for (let x = 0; x < map[y].length; x++) {
                    const variantKey = tileVariantMap[y] ? tileVariantMap[y][x] : null;

                    // 1. 바닥 타일 그리기 (랜덤하게)
                    if (variantKey && variantKey.startsWith('floors_')) {
                        const floorImage = loadedAssets.images[variantKey];
                        if (floorImage) {
                            ctx.drawImage(floorImage, x * tileSize, y * tileSize, tileSize, tileSize);
                        }
                    } else {
                        // 이미지가 없는 경우 기본 바닥(FLOOR) SVG를 그립니다.
                        drawElement(FLOOR, x, y, tileSize);
                    }

                    // 2. 목표 지점 그리기
                    if (levels[currentLevel][y][x] === GOAL) {
                        drawElement(GOAL, x, y, tileSize);
                    }
                    
                    // 3. 벽 또는 오브젝트 그리기
                    if (map[y][x] === WALL) {
                        if (variantKey && variantKey.startsWith('walls_')) {
                            const wallImage = loadedAssets.images[variantKey];
                            if (wallImage) {
                                ctx.drawImage(wallImage, x * tileSize, y * tileSize, tileSize, tileSize);
                            }
                        } else {
                           // 이미지가 없는 경우 기본 벽(WALL) SVG를 그립니다.
                           drawElement(WALL, x, y, tileSize);
                        }
                    } else if (map[y][x] !== FLOOR) {
                        // 벽이 아닌 다른 모든 요소 (플레이어, 박스 등)
                        drawElement(map[y][x], x, y, tileSize);
                    }
                }
            }
        }
        
        function drawElement(element, x, y, size) {
            let imageToDraw = null;
            const imageKey = ELEMENT_IMAGE_MAP[element];

            if (element === PLAYER || element === PLAYER_ON_GOAL) {
                if (loadedAssets.images[currentPlayerSpriteKey]) {
                    imageToDraw = loadedAssets.images[currentPlayerSpriteKey];
                }
            } 
            else if (imageKey && loadedAssets.images[imageKey]) {
                imageToDraw = loadedAssets.images[imageKey];
            }

            if (imageToDraw) {
              if (element === PLAYER || element === PLAYER_ON_GOAL) {
                    if (playerDirection === 'left') {
                        ctx.save();
                        ctx.translate(x * size + size, y * size);
                        ctx.scale(-1, 1);
                        ctx.drawImage(imageToDraw, 0, 0, size, size);
                        ctx.restore();
                    } else {
                        ctx.drawImage(imageToDraw, x * size, y * size, size, size);
                    }
                } else {
                     ctx.drawImage(imageToDraw, x * size, y * size, size, size);
                }
            } else {
                const svgCanvas = preRenderedCanvases[element];
                if (svgCanvas) {
                    if (element === PLAYER || element === PLAYER_ON_GOAL) {
                         if (playerDirection === 'left') {
                            ctx.save();
                            ctx.translate(x * size + size, y * size);
                            ctx.scale(-1, 1);
                            ctx.drawImage(svgCanvas, 0, 0, size, size);
                            ctx.restore();
                        } else {
                            ctx.drawImage(svgCanvas, x * size, y * size, size, size);
                        }
                    } else {
                        if (element === FLOOR && !loadedAssets.images.floor) return;
                        ctx.drawImage(svgCanvas, x * size, y * size, size, size);
                    }
                }
            }
        }


        // --- 초기화 및 이벤트 리스너 ---
        function preRenderSVGs(tileSize) {
            if (tileSize <= 0) return;
            const renderingPromises = Object.keys(SVG_ASSETS).map(key => {
                return new Promise(resolve => {
                    const svgString = SVG_ASSETS[key];
                    const tempCanvas = document.createElement('canvas');
                    tempCanvas.width = tileSize;
                    tempCanvas.height = tileSize;
                    const tempCtx = tempCanvas.getContext('2d');
                    const img = new Image();
                    const svgBlob = new Blob([svgString], { type: 'image/svg+xml;charset=utf-8' });
                    const url = URL.createObjectURL(svgBlob);

                    img.onload = () => {
                        tempCtx.drawImage(img, 0, 0, tileSize, tileSize);
                        preRenderedCanvases[key] = tempCanvas;
                        URL.revokeObjectURL(url);
                        resolve();
                    };
                    img.onerror = () => {
                        console.error(`SVG 렌더링 실패: ${key}`);
                        resolve();
                    };
                    img.src = url;
                });
            });
            return Promise.all(renderingPromises);
        }

        async function initializeGame() {
            levels = parseLevels(levelsData.trim());
            if (levels.length === 0) {
                 document.getElementById('loader-container').innerHTML = '<p class="text-red-400 text-lg">오류: 맵 데이터가 없습니다.</p>';
                return;
            }
            
            populateLevelSelect();
            await preRenderSVGs(100); 
            await loadAllAssets();

            idleIconKeys = Object.keys(loadedAssets.images).filter(key => key.startsWith('status_idle_'));
            
             if (idleIconKeys.length > 0) {
                const initialIconKey = idleIconKeys[0];
                if (loadedAssets.images[initialIconKey]) {
                    actionIconImg.src = loadedAssets.images[initialIconKey].src;
                }
            }

            document.getElementById('loader-container').classList.add('hidden');
            document.getElementById('start-content').classList.remove('hidden');

            setupEventListeners();
        }
        
        function handleMapFile() {
            const fileInput = document.getElementById('map-file-input');
            const statusP = document.getElementById('map-load-status');
            const file = fileInput.files[0];

            if (!file) {
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const content = e.target.result;
                try {
                    const newLevels = parseLevels(content);
                    if (newLevels.length === 0) {
                        throw new Error('맵 데이터가 비어있거나 형식이 올바르지 않습니다.');
                    }
                    levels = newLevels;
                    currentLevel = 0;
                    populateLevelSelect();
                    loadLevel(0);
                    statusP.textContent = `맵 로드 성공! 총 ${levels.length}개의 레벨이 있습니다.`;
                    setTimeout(() => statusP.textContent = '', 3000);
                } catch (error) {
                    statusP.textContent = `오류: ${error.message}`;
                    console.error("맵 파일 처리 중 오류 발생:", error);
                }
            };
            reader.onerror = function() {
                statusP.textContent = '맵 파일을 읽는 중 오류가 발생했습니다.';
                console.error("FileReader 오류");
            };
            
            reader.readAsText(file);
        }

        function setupEventListeners() {
            document.addEventListener('keydown', e => {
                if(document.getElementById('game-wrapper').classList.contains('hidden')) return;
                switch (e.key) {
                    case 'ArrowUp': case 'w': move(0, -1); e.preventDefault(); break;
                    case 'ArrowDown': case 's': move(0, 1); e.preventDefault(); break;
                    case 'ArrowLeft': case 'a': move(-1, 0); e.preventDefault(); break;
                    case 'ArrowRight': case 'd': move(1, 0); e.preventDefault(); break;
                    case 'r': loadLevel(currentLevel); e.preventDefault(); break;
                    case 'z':
                         if (history.length > 0) {
                            const lastState = history.pop();
                            map = lastState.mapState;
                            moveCount = lastState.moveCountState;
                            updateMoveCountDisplay();

                            for (let y = 0; y < map.length; y++) {
                                for (let x = 0; x < map[y].length; x++) {
                                    if (map[y][x] === PLAYER || map[y][x] === PLAYER_ON_GOAL) {
                                        player = { x, y };
                                        break;
                                    }
                                }
                            }
                            draw();
                        }
                        e.preventDefault();
                        break;
                }
            });

            document.getElementById('startGameBtn').addEventListener('click', () => {
                const startScreen = document.getElementById('startScreen');
                startScreen.classList.add('opacity-0');
                setTimeout(() => startScreen.classList.add('hidden'), 300);
                document.getElementById('game-wrapper').classList.remove('hidden');
                
                setTimeout(() => {
                    loadLevel(0);
                }, 10);
            });

            document.getElementById('restartGameBtn').addEventListener('click', () => {
                location.reload(); 
            });

            levelSelect.addEventListener('change', (e) => loadLevel(parseInt(e.target.value)));
            document.getElementById('reset-btn').addEventListener('click', () => loadLevel(currentLevel));
            document.getElementById('prev-level-btn').addEventListener('click', () => { if (currentLevel > 0) loadLevel(currentLevel - 1); });
            document.getElementById('next-level-btn').addEventListener('click', () => { if (currentLevel < levels.length - 1) loadLevel(currentLevel + 1); });
            document.getElementById('modalNextLevelBtn').addEventListener('click', () => {
                hideModal('levelCompleteModal');
                loadLevel(currentLevel + 1);
            });
            
            document.getElementById('up-btn').addEventListener('click', () => move(0, -1));
            document.getElementById('down-btn').addEventListener('click', () => move(0, 1));
            document.getElementById('left-btn').addEventListener('click', () => move(-1, 0));
            document.getElementById('right-btn').addEventListener('click', () => move(1, 0));
            
            const loadMapBtn = document.getElementById('load-map-btn');
            const mapFileInput = document.getElementById('map-file-input');

            loadMapBtn.addEventListener('click', () => {
                mapFileInput.value = null; 
                mapFileInput.click();
            });
            
            mapFileInput.addEventListener('change', handleMapFile);


            window.addEventListener('resize', () => {
                if(document.getElementById('game-wrapper').classList.contains('hidden')) return;
                draw();
            });
        }

        // --- 게임 시작 ---
        initializeGame();

    </script>
</body>
</html>




